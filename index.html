<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zally's Slide Sorter - Gemini Ops Edition</title>
    <!-- Importazione Font Arcade -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --zalando-orange: #FF6900;
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --wall-color: #555;
            --goal-color: #4CAF50; /* Green for "Correct Layout" */
            --box-color: #3498db; /* Blue for "Raw Content" */
            --box-on-goal: #f1c40f; /* Gold for "Optimized Slide" */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #game-container {
            position: relative;
            border: 4px solid var(--zalando-orange);
            box-shadow: 0 0 20px rgba(255, 105, 0, 0.4);
            padding: 10px;
            background-color: #000;
        }

        canvas {
            display: block;
        }

        #ui-layer {
            margin-bottom: 10px;
            text-align: center;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 20px;
            color: var(--zalando-orange);
            margin-bottom: 10px;
            text-shadow: 2px 2px #000;
            line-height: 1.5;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            font-size: 12px;
            margin-top: 10px;
            color: #aaa;
        }

        /* Bottone Reset in Game */
        .reset-btn-ui {
            background: #333;
            border: 1px solid #666;
            color: #fff;
            padding: 5px 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            margin-top: 5px;
        }
        .reset-btn-ui:hover {
            background: #555;
        }

        /* MODAL STYLES (Il cuore didattico) */
        #message-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex; /* Flex per centrare */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .modal-content {
            background: #222;
            border: 2px solid var(--zalando-orange);
            padding: 20px;
            width: 80%;
            max-width: 350px;
            text-align: center;
            line-height: 1.6;
        }

        .modal-title {
            color: var(--zalando-orange);
            font-size: 16px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .modal-text {
            font-size: 11px;
            margin-bottom: 25px;
            color: #ddd;
            white-space: pre-line; /* Permette a capo nel testo JS */
        }

        .btn {
            background: var(--zalando-orange);
            border: none;
            padding: 12px 20px;
            color: white;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            font-size: 10px;
            transition: transform 0.1s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .hidden {
            display: none !important;
        }

        .controls-hint {
            margin-top: 15px;
            font-size: 9px;
            color: #666;
            text-align: center;
            line-height: 1.5;
        }
        
        /* Mobile Controls */
        .mobile-controls {
            display: none; /* Hidden by default on desktop */
            margin-top: 10px;
        }
        .d-pad {
            display: grid;
            grid-template-columns: 40px 40px 40px;
            gap: 5px;
        }
        .pad-btn {
            width: 40px;
            height: 40px;
            background: #444;
            border: none;
            color: white;
            font-size: 18px;
            border-radius: 5px;
        }
        .pad-btn:active { background: var(--zalando-orange); }

        @media (max-width: 600px) {
            .mobile-controls { display: flex; justify-content: center; }
            h1 { font-size: 16px; }
            canvas { width: 320px; height: 320px; } /* Resize for mobile */
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1>ZALLY'S SLIDE SORTER<br><span style="font-size:10px; color:#aaa;">Gemini Ops Edition</span></h1>
        
        <div class="stats-bar">
            <span id="level-display">LVL: 1</span>
            <button class="reset-btn-ui" onclick="resetLevel()">RESET (R)</button>
            <span id="moves-display">MOSSE: 0</span>
        </div>
    </div>

    <div id="game-container">
        <!-- Canvas size will be handled by JS scaling for retina support/mobile -->
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        
        <!-- LEARNING MODAL -->
        <div id="message-modal">
            <div class="modal-content">
                <div id="modal-title" class="modal-title">...</div>
                <div id="modal-text" class="modal-text">...</div>
                <button id="start-btn" class="btn">...</button>
            </div>
        </div>
    </div>

    <!-- Mobile Controls (Visible only on small screens via CSS) -->
    <div class="mobile-controls">
        <div class="d-pad">
            <div></div><button class="pad-btn" onclick="movePlayer(0,-1)">▲</button><div></div>
            <button class="pad-btn" onclick="movePlayer(-1,0)">◄</button><button class="pad-btn" onclick="movePlayer(0,1)">▼</button><button class="pad-btn" onclick="movePlayer(1,0)">►</button>
        </div>
    </div>

    <div class="controls-hint">
        FRECCE per muovere Zally.<br>
        Obiettivo: Spingi le casse BLU sui punti VERDI.
    </div>

<script>
/**
 * ZALLY'S SLIDE SORTER - ENGINE
 * Livelli aggiornati per migliore giocabilità.
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const tileSize = 40; // Base tile size

// --- ASSETS & COLORS ---
const SPRITES = {
    floor: '#222',
    wall: '#555',
    goal: '#2ecc71', // Green layout slot
    box: '#3498db',   // Blue content box
    boxOnGoal: '#f1c40f', // Gold/Complete
    player: '#FF6900', // Zally Orange
    playerHelmet: '#F1C40F' // Yellow Helmet
};

// --- GAME STATE ---
let currentLevelIdx = 0;
let moves = 0;
let playerPos = {x: 0, y: 0};
let gameMap = [];
let gameRunning = false;

// --- EDUCATIONAL CONTENT ---
const LEVEL_MESSAGES = [
    {
        title: "BENVENUTO IN OPS!",
        text: "Ciao! Sono Zally.\nLa tua Inbox è piena di dati disordinati (Casse Blu).\n\nDevi organizzarli nel Template della Slide (Punti Verdi).\n\nSpostare i blocchi a mano è faticoso... proviamo!",
        btn: "INIZIA IL TURNO"
    },
    {
        title: "LIVELLO 2: SPAZIO DI MANOVRA",
        text: "Ottimo lavoro col testo!\n\nOra abbiamo due elementi: Dati e Immagini.\nAttento agli angoli! Se spingi una cassa contro il muro sbagliato, non potrai più muoverla.\n\n(Usa RESET se ti blocchi)",
        btn: "PROSSIMO TASK"
    },
    {
        title: "LIVELLO 3: QBR DEADLINE",
        text: "Il management aspetta la presentazione.\nDevi allineare Titolo, Grafici e Immagini.\n\nÈ tutto molto stretto qui... proprio come le nostre scadenze!\n\nPianifica le tue mosse.",
        btn: "ACCETTA LA SFIDA"
    },
    {
        title: "MISSIONE COMPIUTA!",
        text: "Che fatica spostare tutto a mano!\n\nCON GEMINI IN SLIDES:\nBasta un prompt per 'spostare le casse' istantaneamente.\n\nPrompt Esempio:\n'Crea una slide a 3 colonne con questi dati'\n\nGrazie per aver giocato!",
        btn: "TORNA ALL'INIZIO"
    }
];

// --- LEVEL DESIGN (UPDATED) ---
// Legenda: #: Muro, @: Zally, $: Box, .: Goal, " ": Pavimento
const LEVELS = [
    [ // Livello 1 - Tutorial (Facile)
        "##########",
        "##      ##",
        "##      ##",
        "##  @   ##",
        "## $    ##",
        "##  .   ##",
        "##      ##",
        "##########",
        "##########",
        "##########"
    ],
    [ // Livello 2 - Fixato (Più spazioso, impossibile bloccarsi subito)
        "##########",
        "##      ##",
        "## .    ##",
        "##   $  ##",
        "##  $   ##",
        "##    . ##",
        "##  @   ##",
        "##      ##",
        "##########",
        "##########"
    ],
    [ // Livello 3 - Challenge
        "##########",
        "##      ##",
        "##  .   ##",
        "## $.$  ##",
        "##  @   ##",
        "##  $   ##",
        "##  .   ##",
        "##      ##",
        "##########",
        "##########"
    ]
];

// --- CORE FUNCTIONS ---

function loadLevel(idx) {
    if (idx >= LEVELS.length) {
        showModal(LEVEL_MESSAGES[3]); // Vittoria
        currentLevelIdx = 0; // Prepare for restart
        return;
    }

    currentLevelIdx = idx;
    moves = 0;
    updateUI();
    
    gameRunning = false;
    // Usa messaggio specifico o default se mancasse
    const msg = LEVEL_MESSAGES[idx] || {title: `LIVELLO ${idx+1}`, text: "Risolvi il puzzle!", btn: "VAI"};
    showModal(msg);

    // Parsing Mappa
    gameMap = [];
    const levelRaw = LEVELS[idx];
    
    for (let y = 0; y < levelRaw.length; y++) {
        let row = levelRaw[y].split('');
        let pIndex = row.indexOf('@');
        if (pIndex !== -1) {
            playerPos = {x: pIndex, y: y};
            row[pIndex] = ' '; 
        }
        gameMap.push(row);
    }
    
    draw();
}

function resetLevel() {
    loadLevel(currentLevelIdx);
}

function draw() {
    // Pulisci canvas
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    for (let y = 0; y < gameMap.length; y++) {
        for (let x = 0; x < gameMap[y].length; x++) {
            const cell = gameMap[y][x];
            const posX = x * tileSize;
            const posY = y * tileSize;

            // Pavimento
            ctx.fillStyle = SPRITES.floor;
            ctx.fillRect(posX, posY, tileSize, tileSize);

            if (cell === '#') {
                // Muro con effetto 3D
                ctx.fillStyle = SPRITES.wall;
                ctx.fillRect(posX, posY, tileSize, tileSize);
                ctx.fillStyle = '#666'; 
                ctx.fillRect(posX+2, posY+2, tileSize-4, tileSize-4); // Inner light
                ctx.strokeStyle = '#333';
                ctx.strokeRect(posX, posY, tileSize, tileSize);
            } 
            else if (cell === '.') {
                // Goal
                ctx.fillStyle = SPRITES.goal;
                ctx.beginPath();
                ctx.arc(posX + tileSize/2, posY + tileSize/2, 6, 0, Math.PI*2);
                ctx.fill();
                // Marker Layout
                ctx.strokeStyle = '#27ae60';
                ctx.lineWidth = 2;
                ctx.strokeRect(posX+8, posY+8, tileSize-16, tileSize-16);
            } 
            else if (cell === '$') {
                drawBox(posX, posY, false);
            } 
            else if (cell === '*') {
                drawBox(posX, posY, true);
            }
        }
    }

    drawZally(playerPos.x * tileSize, playerPos.y * tileSize);
}

function drawBox(x, y, isCompleted) {
    const color = isCompleted ? SPRITES.boxOnGoal : SPRITES.box;
    // Base Box
    ctx.fillStyle = color;
    ctx.fillRect(x+4, y+4, tileSize-8, tileSize-8);
    
    // Dettaglio "Cassa" (X o bordo)
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 2;
    ctx.strokeRect(x+8, y+8, tileSize-16, tileSize-16);
    
    // Testo
    ctx.fillStyle = isCompleted ? '#000' : '#fff';
    ctx.font = '8px "Press Start 2P"';
    ctx.fillText(isCompleted ? "OK" : "DAT", x+10, y+24);
}

function drawZally(x, y) {
    // Ombra
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.beginPath();
    ctx.ellipse(x+20, y+36, 12, 4, 0, 0, Math.PI*2);
    ctx.fill();

    // Corpo
    ctx.fillStyle = SPRITES.player;
    ctx.fillRect(x+6, y+10, tileSize-12, tileSize-14);
    
    // Caschetto (Safety First)
    ctx.fillStyle = SPRITES.playerHelmet;
    ctx.fillRect(x+4, y+6, tileSize-8, 10); // Top
    ctx.fillRect(x+16, y+4, 8, 4); // Light bump
    
    // Occhi (Pixel)
    ctx.fillStyle = '#111';
    ctx.fillRect(x+10, y+20, 4, 4);
    ctx.fillRect(x+26, y+20, 4, 4);
}

function movePlayer(dx, dy) {
    if (!gameRunning) return;

    const newX = playerPos.x + dx;
    const newY = playerPos.y + dy;
    
    // Boundary check
    if(newY < 0 || newY >= gameMap.length || newX < 0 || newX >= gameMap[0].length) return;

    const targetCell = gameMap[newY][newX];

    // Logica Muro
    if (targetCell === '#') return;

    // Movimento Libero
    if (targetCell === ' ' || targetCell === '.') {
        playerPos.x = newX;
        playerPos.y = newY;
        moves++;
    } 
    // Spinta Cassa
    else if (targetCell === '$' || targetCell === '*') {
        const nextX = newX + dx;
        const nextY = newY + dy;
        const nextCell = gameMap[nextY][nextX];

        if (nextCell === ' ' || nextCell === '.') {
            // Muovi la cassa
            gameMap[nextY][nextX] = (nextCell === '.') ? '*' : '$';
            gameMap[newY][newX] = (targetCell === '*') ? '.' : ' ';
            
            playerPos.x = newX;
            playerPos.y = newY;
            moves++;
        }
    }

    updateUI();
    draw();
    checkWin();
}

function checkWin() {
    let remaining = 0;
    for (let row of gameMap) {
        for (let cell of row) {
            if (cell === '$') remaining++;
        }
    }

    if (remaining === 0) {
        gameRunning = false;
        setTimeout(() => {
            loadLevel(currentLevelIdx + 1);
        }, 500);
    }
}

function updateUI() {
    document.getElementById('level-display').innerText = `LVL: ${currentLevelIdx + 1}`;
    document.getElementById('moves-display').innerText = `MOSSE: ${moves}`;
}

// --- MODAL SYSTEM ---
const modal = document.getElementById('message-modal');
const modalTitle = document.getElementById('modal-title');
const modalText = document.getElementById('modal-text');
const startBtn = document.getElementById('start-btn');

function showModal(content) {
    modalTitle.innerText = content.title;
    modalText.innerText = content.text;
    startBtn.innerText = content.btn;
    modal.classList.remove('hidden');
    
    startBtn.onclick = () => {
        if(content.title === "MISSIONE COMPIUTA!") {
             location.reload(); 
        } else {
            modal.classList.add('hidden');
            gameRunning = true;
            draw();
        }
    };
}

// --- KEYBOARD CONTROLS ---
document.addEventListener('keydown', (e) => {
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) e.preventDefault();

    if (e.key === 'r' || e.key === 'R') resetLevel();

    switch(e.key) {
        case 'ArrowUp': movePlayer(0, -1); break;
        case 'ArrowDown': movePlayer(0, 1); break;
        case 'ArrowLeft': movePlayer(-1, 0); break;
        case 'ArrowRight': movePlayer(1, 0); break;
    }
});

// INIT
loadLevel(0);

</script>
</body>
</html>
